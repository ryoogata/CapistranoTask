#############################################################################
## Utilities.
def unindent(s)
  return s.gsub(/^\s+/, '')
end

#############################################################################
## Settins:
load 'config.rb'

#############################################################################
## Attribute.

# fswiki の本体がインストールされる Directory
# ( 4.0.0 - 4.0.8 がインストール可能 )
set :_RT_SOURCE, 'rt-4.0.8.tar.gz'


#############################################################################
## TASKS.

task :provision do
	install_preRTpackage	
	install_mysql
	install_apache
	install_RTpackage
	rt4_install
	rt_http
end


desc "Install PreRequire RT 4 Package install"
task :install_preRTpackage do
	# EPEL と RPM Forge のレポジトリのインストール
	run 'rpm -Uv http://ftp-srv2.kddilabs.jp/Linux/distributions/fedora/epel/6/x86_64/epel-release-6-7.noarch.rpm'
	run 'rpm -Uv http://pkgs.repoforge.org/rpmforge-release/rpmforge-release-0.5.2-2.el6.rf.x86_64.rpm'

	# 事前に必要なパッケージをインストール
	packages = %w[
		perl perl-CPAN
		cpp gcc* autoconf* automake* libtool m4 make
		gd gd-devel libpng libpng-devel libjpeg libjpeg-devel freetype freetype-devel
	]
	run "sudo yum -y install #{packages.join(' ')}"
end


desc "Install MySQL Server"
task :install_mysql do
  run 'yum -y install mysql-server'
  run 'chkconfig mysqld on'
  run 'service mysqld start'
end


desc "Install Apache"
task :install_apache do
  run 'yum -y install httpd httpd-devel'
end


desc "Install RT 4 Package install"
task :install_RTpackage do
  run 'yum -y install perl-CSS-*' 
  run 'yum -y install perl-MIME-Types'
  run 'yum -y install perl-Text*'
  run 'yum -y install perl-XML-RSS'
  run 'yum -y install perl-MIME-tools'
  run 'yum -y install perl-GD'
  run 'yum -y install perl-GDGraph'
  run 'yum -y install perl-CGI*'
  run 'yum -y install perl-TermReadKey'
  run 'yum -y install perl-Time-modules'
  run 'yum -y install perl-Class-ReturnValue'
  run 'yum -y install perl-Text-Quoted'
  run 'yum -y install perl-Module-Versions-Report'
  run 'yum -y install perl-Apache-Session-Wrapper'
  run 'yum -y install perl-Cache-Simple-TimedExpiry'
  run 'yum -y install perl-Calendar-Simple'
  run 'yum -y install perl-HTML-Scrubber'
  run 'yum -y install perl-HTML-Tree'
  run 'yum -y install perl-HTML-Format'
  run 'yum -y --enablerepo=rpmforge-extras install perl-Class-Accessor'
  run 'yum -y --enablerepo=rpmforge-extras install perl-Plack'
  run 'yum -y install perl-Regexp*'
  run 'yum -y install perl-Net-Server'
  run 'yum -y install perl-PerlIO-eol'
  run 'yum -y install perl-Locale-Maketext-Fuzzy perl-Locale-Maketext-Lexicon'
  run 'yum -y install perl-HTTP-Server-Simple'
  run 'yum -y install perl-HTTP-Server-Simple-Mason'
  run 'yum -y install perl-File-ShareDir'
  run 'yum -y install perl-Email-Address'
  run 'yum -y install perl-DBIx-SearchBuilder'
  run 'yum -y install perl-Moose'
  run 'yum -y install perl-Data-ICal'
  run 'yum -y install perl-Log-Dispatch'
  run 'yum -y install perl-Tree-Simple'
  run 'yum -y install fcgi-perl'
  run 'yum -y install perl-IPC-Run3'
  run 'yum -y install perl-GnuPG-Interface'
  run 'yum -y install perl-FCGI*'
  run 'yum -y install perl-JSON*'
  run 'yum -y install perl-Net-CIDR'
  run 'yum -y install mod_fastcgi'
  run 'yum -y install perl-JavaScript-Minifier'
  run 'yes | cpan CGI::PSGI'
  run 'yes | cpan Encode'
  run 'yes | cpan HTML::RewriteAttributes'
  run 'yes | cpan URI'
  run 'yes | cpan HTML::Mason'
  run 'yes | cpan HTML::Mason::PSGIHandler'
  run 'yes | cpan Plack::Handler::Starlet'
  run 'yes | cpan Convert::Color'
  run 'yes | cpan Regexp::IPv6'
  run 'yes | cpan HTML::Quoted'
  run 'yes | cpan DBIx::SearchBuilder'
end


task :rt4_install do
        RT_DIR = _RT_SOURCE.slice(0..7)

	run <<-CMD
		cd /usr/local/src ; wget http://download.bestpractical.com/pub/rt/release/#{_RT_SOURCE} ; tar xzpvf #{_RT_SOURCE} &&
		cd /usr/local/src/#{RT_DIR} ; pwd
		cd /usr/local/src/#{RT_DIR} ; sh configure ; make install
		chmod -R u+rwX,go-w,go+rX /opt/rt4/share/html /opt/rt4/local/html /opt/rt4/share/po /opt/rt4/local/po
		chown -R root /opt/rt4/share/html /opt/rt4/local/html /opt/rt4/share/po /opt/rt4/local/po
		chgrp -R bin /opt/rt4/share/html /opt/rt4/local/html /opt/rt4/share/po /opt/rt4/local/po
		chmod 0770 /opt/rt4/var/mason_data /opt/rt4/var/session_data
		chown -R apache /opt/rt4/var/mason_data /opt/rt4/var/session_data
		chgrp -R apache /opt/rt4/var/mason_data /opt/rt4/var/session_data
		cd /usr/local/src/#{RT_DIR} ; echo | make initialize-database
	CMD
end


task :rt_http do
	put unindent(<<-'CONF'), '/etc/httpd/conf.d/rt.conf'
		<VirtualHost *:80>
		### Optional apache logs for RT
		# Ensure that your log rotation scripts know about these files
		# ErrorLog /opt/rt4/var/log/apache2.error
		# TransferLog /opt/rt4/var/log/apache2.access
		# LogLevel debug

		AddDefaultCharset UTF-8

		Alias /NoAuth/images/ /opt/rt4/share/html/NoAuth/images/
		ScriptAlias / /opt/rt4/sbin/rt-server.fcgi/

		DocumentRoot "/opt/rt4/share/html"
		<Location />
		Order allow,deny
		Allow from all
		Options +ExecCGI
		AddHandler fastcgi-script fcgi
		</Location>
		</VirtualHost>
	CONF
	run '/etc/init.d/httpd restart'
end
